<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Hedge.fun App</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Oswald:wght@200;300;400;500;600;700&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800">
	<link rel="icon" type="image/png" href="images/logo.png">
	</head>

	<body>

		<!-- HEADER -->
		<header class="header">
			<a href="./" class="logo"><img src="images/logo.png" alt="Hedge.fun"></a>
			<div class="header-right">
				<span id="wallet-cap" class="wallet-cap" hidden>Cap.: null SOL</span>
				<button id="connectWalletBtn" class="btn btn-round btn-connect">Connect</button>
			</div>
		</header>

		<main>
			
			<!-- SECTION: Connect Wallet -->
			<section id="ConnectWallet" class="section">
				<div class="connect-dashboard">
					<img src="images/Empty wallet.png" alt="Empty Wallet" class="wallet-img">
					<p>Connect your Solana wallet</p>
					<button id="connectBtn" class="btn btn-gradient btn-round">
					  Connect Wallet
					</button>
				</div>
			</section>

			<!-- SECTION: Dashboard -->
			<section id="Dashboard" class="section" hidden>
				<h2>Dashboard</h2>
				<div class="balance">
				<div class="balance-right">
					<h4>Your balance:</h4>
					<h3 id="balance__sol">Null</h3>
					<h4 id="balance__usd">Null</h4>
					<h5 id="balance__rate">...</h5>
					<span id="walletStatus" style="color:#9ac31c; font-size:18px; margin-bottom:20px;">
					Not connected
					</span>
				</div>
				</div>

				<a href="#" id="hedgeBtn" class="btn btn-gradient btn-round">Hedge my position</a>

				<!-- SECTION: My Positions -->
				<section id="MyPositions" class="section" hidden>
					<h2>Hedge My Position</h2>
					<div class="table-container">
						<p>Select which assets you want to hedge (only positions above $20 are shown):</p>
						<div class="table-wrapper">
							<table class="hedge-table">
								<thead>
									<tr>
										<th>Select</th>
										<th>Asset</th>
										<th>Balance</th>
										<th>Value (USD)</th>
									</tr>
								</thead>
								<tbody id="positions-body">
									<tr><td colspan="4">Loading positions...</td></tr>
								</tbody>
							</table>
						</div>

						<div class="active-hedges" style="margin-top:30px;">
							<h3>Active Hedges</h3>
							<table class="hedge-table" id="hedgeTable">
								<thead>
									<tr>
										<th>Market</th>
										<th>Size</th>
										<th>To Win</th>
										<th>To Pay</th>
										<th>Status</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="hedgeTableBody">
									<tr><td colspan="6">No active hedges yet.</td></tr>
								</tbody>
							</table>
						</div>

					</div>
					<a href="#" id="addHedgeBtn" class="btn btn-gradient btn-round">Add new hedge</a>
				</section>
				<script>
				function getTokenIcon(symbol) {
					const s = symbol.toUpperCase();
					const icons = {
						SOL: "https://assets.coingecko.com/coins/images/4128/large/solana.png",
						USDC: "https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png",
						BONK: "https://assets.coingecko.com/coins/images/28600/large/bonk.jpg"
					};
					return icons[s] || `https://cryptoicons.org/api/icon/${s.toLowerCase()}/64`;
				}
				async function loadUserPositions(walletAddress) {
					const tbody = document.getElementById("positions-body");
					tbody.innerHTML = "<tr><td colspan='4'>Loading positions...</td></tr>";
					try {
						const params = new URLSearchParams();
						params.append("account_id", walletAddress);

						const resp = await fetch("/positions", {
							method: "POST",
							headers: { "Content-Type": "application/x-www-form-urlencoded" },
							body: params.toString()
						});
						const html = await resp.text();
						tbody.innerHTML = html;
						// Підтягуємо іконки
						tbody.querySelectorAll(".token-icon").forEach(img => {
							const symbol = img.dataset.symbol;
							img.src = getTokenIcon(symbol);
							img.width = 24;
							img.height = 24;
							img.style.marginRight = "8px";
							img.style.verticalAlign = "middle";
						});
						document.getElementById("MyPositions").hidden = false;
					} catch (err) {
						console.error("Помилка під час завантаження позицій:", err);
						tbody.innerHTML = "<tr><td colspan='4'>Failed to load positions</td></tr>";
					}
				}
				</script>

				<h3>Crypto Price Chart</h3>
				<canvas id="cryptoChart"></canvas>
				<div style="margin-top:10px; margin-bottom:20px;">
				<label><input type="radio" name="currency" value="SOL" checked> SOL</label>
				<label style="margin-left:10px;"><input type="radio" name="currency" value="USDC"> USDC</label>
				<label style="margin-left:10px;"><input type="radio" name="currency" value="MET"> $MET</label>
				<label style="margin-left:20px;"><input type="checkbox" id="toggleForecast" checked> Show Forecast</label>
				<label style="margin-left:10px;"><input type="checkbox" id="toggleEMA" checked> Show EMA</label>
				</div>
			</section>

			<!-- SECTION: Referral -->
			<section id="Referral" class="section" hidden>
				<h3>Invite your friends and earn rewards!</h3>
				<a href="#" class="btn btn-gradient btn-round">Get referral link</a>
			</section>
		</main>

		<!-- FOOTER -->
		<footer class="footer">
			<div class="footer-content">
				<a href="https://x.com/hedgeyourfun" target="_blank" class="social-link">
					<img src="images/twitter.png" alt="Twitter" class="social-icon">
				</a>
				<a href="https://docs.hedgeyour.fun" class="social-link">
					<img src="images/git.png" alt="FAQ" class="social-icon">
				</a>
				<a href="https://linktr.ee/HedgeYourFun" class="social-link">
					<img src="images/linktree.png" alt="FAQ" class="social-icon">
				</a>
				<!-- <a href="#" class="social-link">
					<img src="images/discord.png" alt="Discord" class="social-icon">
				</a> -->
			</div>
		</footer>

		<!-- BACKGROUND ANIMATION -->
		<div class="crypto-bg">
			<span>₿</span>
			<span>Ξ</span>
			<span>SOL</span>
			<span>$</span>
			<span>₿</span>
			<span>Ξ</span>
			<span>SOL</span>
			<span>$</span>
		</div>

		<script>
			document.getElementById('hedgeBtn').addEventListener('click', () => {
				document.getElementById('MyPositions').hidden = false;
				});
		</script>

		<!-- Loading popup -->
		<div id="popup-overlay" class="popup-overlay">
			<div id="popup-add-hedge" class="popup">
				<img src="images/loading.png" alt="Loading" class="loading" style="width:60px; margin-bottom:20px;">
				<h3>Processing your hedge...</h3>
			</div>
		</div>

		<!-- Wallet Connect Popup -->
		<div id="popup-wallet-overlay" class="popup-overlay">
		<div id="popup-wallet" class="popup" style="max-width: 400px; text-align: center;">
			<h2 style="margin-bottom: 20px;">Connect Wallet</h2>
			<div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
			<button id="wallet-phantom" class="wallet-btn" style="background: none; border: none; cursor: pointer;">
				<img src="images/phantom.png" alt="Phantom" style="width:80px; height:80px;">
				<p style="color:#fff; font-size:18px;">Phantom</p>
			</button>
			<button id="wallet-backpack" class="wallet-btn" style="background: none; border: none; cursor: pointer;">
				<img src="images/backpack.png" alt="Backpack" style="width:80px; height:80px;">
				<p style="color:#fff; font-size:18px;">Backpack</p>
			</button>
			</div>

			<div id="manual-wallet" style="text-align: center;">
			<p style="color:#ccc; margin-bottom: 10px;">Or enter wallet address manually:</p>
			<form hx-post="/account" hx-swap="none" hx-on::after-request="if(event.detail.successful) this.reset()">
				<input
					name="account_id"
					id="manualWalletInput" 
					type="text" 
					placeholder="Enter wallet address" 
					style="width: 90%; padding: 10px; border-radius: 8px; border: none; font-size: 16px; text-align: center;">
				<button
					id="manualWalletBtn" 
					type="submit"
					style="margin-top: 15px; padding: 10px 25px; border: none; border-radius: 8px; background-color: #9ac31c; color: #000; font-weight: bold; cursor: pointer;">
					OK
				</button>
			</form>
			</div>
		</div>
		</div>

		<!-- Hedge Offer Popup -->
		<div id="popup-hedge-offer-overlay" class="popup-overlay">
		<div id="popup-hedge-offer" class="popup" style="max-width: 650px;">
			<h2 style="margin-bottom: 15px;">Hedge Offer</h2>
			<p style="margin-bottom: 15px;">Choose hedge position<br>Select a market to hedge your exposure.</p>

			<!-- Offer block -->
			<div style="font-family: Arial, sans-serif; color: #ffffff; background-color: #1a2a50; padding: 20px; border-radius: 12px; max-width: 600px; margin: auto;">
			<div class="table-wrapper" style="overflow-x:auto; margin-top: 10px;">
				<table style="width: 100%; border-collapse: collapse; background-color: #243b70; border-radius: 8px; overflow: hidden;">
				<thead>
					<tr style="background-color: #1f2e5a;">
					<th style="padding: 10px; text-align: left;">Market</th>
					<th style="padding: 10px; text-align: left;">Size</th>
					<th style="padding: 10px; text-align: left;">To Win</th>
					<th style="padding: 10px; text-align: left;">Link</th>
					<th style="padding: 10px; text-align: left;">To Pay</th>
					<th style="padding: 10px; text-align: left;">Hedge</th>
					</tr>
				</thead>
				<tbody>
					<!-- Example row: Sol price in 2026 10% -->
					<tr>
					<td style="padding: 10px;">Sol price in 2026</td>
					<td style="padding: 10px;">10%</td>
					<td style="padding: 10px;">$850</td>
					<td style="padding: 10px;">
						<a href="https://polymarket.com" target="_blank" rel="noopener noreferrer" title="Open Polymarket">
						<img src="images/Polymarket_logo.png" alt="Polymarket" style="width:24px; height:24px; vertical-align:middle; cursor:pointer;">
						</a>
					</td>
							<path fill="#ffffff" d="M14 3h7v7h-2V6.41l-9.29 9.3-1.41-1.42 9.3-9.29H14V3z"/>
							<path fill="#ffffff" d="M5 5h5V3H3v7h2V5z"/>
							<path fill="#ffffff" d="M19 19H5V7h2v10h12v2z"/>
						</svg>
						polymarket
						</a>
					</td>
					<td style="padding: 10px;">$85</td>
					<td style="padding: 10px; text-align:center;">
						<input type="radio" name="hedge-select" value="sol-2026" aria-label="Select Sol price in 2026">
					</td>
					</tr>

					<!-- Example row: Sol price in 2026 15% -->
					<tr>
					<td style="padding: 10px;">Sol price in 2026</td>
					<td style="padding: 10px;">15%</td>
					<td style="padding: 10px;">$850</td>
					<td style="padding: 10px;">
						<a href="https://polymarket.com" target="_blank" rel="noopener noreferrer" title="Open Polymarket">
						<img src="images/Polymarket_logo.png" alt="Polymarket" style="width:24px; height:24px; vertical-align:middle; cursor:pointer;">
						</a>
					</td>
							<path fill="#ffffff" d="M14 3h7v7h-2V6.41l-9.29 9.3-1.41-1.42 9.3-9.29H14V3z"/>
							<path fill="#ffffff" d="M5 5h5V3H3v7h2V5z"/>
							<path fill="#ffffff" d="M19 19H5V7h2v10h12v2z"/>
						</svg>
						polymarket
						</a>
					</td>
					<td style="padding: 10px;">$127.5</td>
					<td style="padding: 10px; text-align:center;">
						<input type="radio" name="hedge-select" value="sol-2026" aria-label="Select Sol price in 2026">
					</td>
					</tr>
				</tbody>
				</table>
			</div>

			<div style="margin-top: 20px; background-color: #243b70; padding: 10px 15px; border-radius: 8px;">
				<p style="margin-bottom: 8px; font-weight: bold;">Payment options:</p>
				<label style="display: block; margin-bottom: 5px;">
				<input type="radio" name="payment-option" checked value="deduct">
				Deduct from portfolio
				</label>
				<label style="display: block;">
				<input type="radio" name="payment-option" value="outside">
				Pay outside portfolio
				</label>
			</div>
			</div>

			<button id="hedgeNowBtn" class="btn btn-gradient btn-round" style="margin-top: 20px;">Hedge now</button>
		</div>
		</div>

		<!-- Confirmation Popup -->
		<div id="popup-hedge-confirmation-overlay" class="popup-overlay">
			<div id="popup-hedge-confirmation" class="popup" style="max-width: 500px; text-align:center;">
				<img src="images/solana-sol-logo.png" alt="Solana" style="width:70px; margin-bottom:15px;">
				<h2 style="margin-bottom: 10px;">Confirm transaction in your wallet</h2>
				<p style="font-style: italic; margin-bottom: 20px;">
					Please check your wallet to approve this transaction.
				</p>
			</div>
		</div>

		<!-- Result Popup -->
		<div id="popup-hedge-result-overlay" class="popup-overlay">
			<div id="popup-hedge-result" class="popup" style="max-width: 500px; text-align:center;">
				<img src="images/Success.png" alt="Success" style="width:70px; margin-bottom:15px;">
				<h2 style="margin-bottom: 10px;">Hedge completed successfully!</h2>
				<p style="margin-bottom: 20px;">Manage it via Dashboard.</p>
				<button class="btn btn-gradient btn-round" style="margin-bottom:10px;" onclick="document.querySelectorAll('.popup-overlay').forEach(o => o.style.display='none')">
					Go to Dashboard
				</button>
				<button id="shareTwitterBtn" class="btn btn-round" style="background-color:#1a2a50; border:1px solid #9ac31c; color:#9ac31c;">
					Share on Twitter
				</button>
				<canvas id="shareCanvas" width="800" height="400" style="display:none;"></canvas>
			</div>
		</div>
		<audio id="popup-sound" src="effects/fanfare 2.mp3" preload="auto"></audio>

		<div id="popup-hedge-error-overlay" class="popup-overlay" style="display:none;">
		<div id="popup-hedge-error" class="popup" style="max-width: 500px; text-align:center;">
			<img src="images/Error.png" alt="Error" style="width:70px; margin-bottom:15px;">
			<h2 style="margin-bottom: 10px; color:#ec6320;">Hedge failed!</h2>
			<p style="margin-bottom: 20px;">Please try again later.</p>
			<button class="btn btn-gradient btn-round" style="margin-bottom:10px;"
			onclick="document.querySelectorAll('.popup-overlay').forEach(o => o.style.display='none')">
			Go to Dashboard
			</button>
		</div>
		</div>
		<audio id="popup-error-sound" src="effects/disappointment 2.mp3" preload="auto"></audio>

	<!-- BACKGROUND PARTICLES -->
	<div id="particles-js" style="position:fixed; width:100%; height:100%; top:0; left:0; z-index:-1;"></div>

	<script src="js/main.js" defer></script>

	</body>
</html>
