<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Hedge.fun App</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Oswald:wght@200;300;400;500;600;700&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800">
		<link rel="icon" type="image/png" href="images/logo.png">
	</head>
	<body>

		<!-- HEADER -->
		<header class="header">
			<a href="./" class="logo"><img src="images/logo.png" alt="Hedge.fun"></a>
			<div class="header-right">
				<span class="wallet-cap">Cap.: 000 SOL</span>
				<button id="connectWalletBtn" class="btn btn-round btn-connect">Connect</button>
			</div>
		</header>

		<main>
			<!-- SECTION: Connect Wallet -->
			<section id="ConnectWallet" class="section">
				<div class="connect-dashboard">
					<img src="images/Empty wallet.png" alt="Empty Wallet" class="wallet-img">
					<p>Connect your Solana wallet</p>
					<button id="connectBtn" class="btn btn-gradient btn-round">Connect Wallet</button>
				</div>
			</section>

			<!-- SECTION: Dashboard -->
			<section id="Dashboard" class="section" hidden>
				<h2>Dashboard</h2>
				<div class="balance">
					<div class="balance-right">
						<h4>Your balance:</h4>
						<h3>$0.00</h3>
					</div>
				</div>
				<h3>Crypto Price Chart</h3>
				<canvas id="cryptoChart"></canvas>
				<div style="margin-top:10px; margin-bottom:20px;">
					<label><input type="radio" name="currency" value="SOL" checked>
					SOL</label>
					<label style="margin-left:10px;"><input type="radio" name="currency" value="USDC">
					USDC</label>
					<label style="margin-left:10px;"><input type="radio" name="currency" value="MET">
					$MET</label>
					<label style="margin-left:20px;"><input type="checkbox" id="toggleForecast" checked>
					Show Forecast</label>
					<label style="margin-left:10px;"><input type="checkbox" id="toggleEMA" checked>
					Show EMA</label>
				</div>
				<a href="#" id="hedgeBtn" class="btn btn-gradient btn-round">Hedge my position</a>
			</section>

			<!-- SECTION: My Positions -->
			<section id="MyPositions" class="section" hidden>
				<h2>Hedge My Position</h2>
				<div class="table-container">
					<p>Select which assets you want to hedge (only positions above $20 are shown):</p>
					<div class="table-wrapper">
						<table class="hedge-table">
							<thead>
								<tr>
									<th>Select</th>
									<th>Asset</th>
									<th>Balance</th>
									<th>Value (USD)</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td><input type="checkbox"></td>
									<td><img class="token-icon" data-symbol="SOL" alt="SOL">
									SOL</td>
									<td>5.42</td>
									<td>$620.18</td>
								</tr>
								<tr>
									<td><input type="checkbox"></td>
									<td><img class="token-icon" data-symbol="USDC" alt="USDC">
									USDC</td>
									<td>350.00</td>
									<td>$350.00</td>
								</tr>
								<tr>
									<td><input type="checkbox"></td>
									<td><img class="token-icon" data-symbol="BONK" alt="BONK">
									BONK</td>
									<td>1542000</td>
									<td>$135.72</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<a href="#" id="addHedgeBtn" class="btn btn-gradient btn-round">Add new hedge</a>
			</section>

			<!-- SECTION: Referral -->
			<section id="Referral" class="section" hidden>
				<h3>Invite your friends and earn rewards!</h3>
				<a href="#" class="btn btn-gradient btn-round">Get referral link</a>
			</section>
		</main>

		<!-- FOOTER -->
		<footer class="footer">
			<div class="footer-content">
				<a href="https://twitter.com/name" target="_blank" class="social-link">
					<img src="images/twitter.png" alt="Twitter" class="social-icon">
				</a>
				<a href="#" class="social-link">
					<img src="images/gitlab.png" alt="Gitbook" class="social-icon">
				</a>
				<a href="#" class="social-link">
					<img src="images/faq.png" alt="FAQ" class="social-icon">
				</a>
				<a href="#" class="social-link">
					<img src="images/discord.png" alt="Discord" class="social-icon">
				</a>
			</div>
		</footer>

		<!-- BACKGROUND ANIMATION -->
		<div class="crypto-bg">
			<span>₿</span>
			<span>Ξ</span>
			<span>SOL</span>
			<span>$</span>
			<span>₿</span>
			<span>Ξ</span>
			<span>SOL</span>
			<span>$</span>
		</div>

		<script>
			document.getElementById('connectBtn').addEventListener('click', () => {
				document.getElementById('ConnectWallet').hidden = true;
				document.getElementById('Dashboard').hidden = false;
				document.getElementById('Referral').hidden = false;
				});
				document.getElementById('hedgeBtn').addEventListener('click', () => {
					document.getElementById('MyPositions').hidden = false;
					});
		</script>
		<!-- Loading popup -->
		<div id="popup-overlay" class="popup-overlay">
			<div id="popup-add-hedge" class="popup">
				<img src="images/loading.png" alt="Loading" class="loading" style="width:60px; margin-bottom:20px;">
				<h3>Processing your hedge...</h3>
			</div>
		</div>

		<!-- Wallet Connect Popup -->
		<div id="popup-wallet-overlay" class="popup-overlay">
			<div id="popup-wallet" class="popup" style="max-width: 400px; text-align: center;">
				<h2 style="margin-bottom: 20px;">Connect Wallet</h2>
				<div style="display: flex; justify-content: center; gap: 30px;">
					<button id="wallet-phantom" class="wallet-btn" style="background: none; border: none; cursor: pointer;">
						<img src="images/phantom.png" alt="Phantom" style="width:80px; height:80px;">
						<p style="color:#fff; font-size:18px;">Phantom</p>
					</button>
					<button id="wallet-backpack" class="wallet-btn" style="background: none; border: none; cursor: pointer;">
						<img src="images/backpack.png" alt="Backpack" style="width:80px; height:80px;">
						<p style="color:#fff; font-size:18px;">Backpack</p>
					</button>
				</div>
			</div>
		</div>

		<!-- Hedge Offer Popup -->
		<div id="popup-hedge-offer-overlay" class="popup-overlay">
			<div id="popup-hedge-offer" class="popup" style="max-width: 650px;">
				<h2 style="margin-bottom: 15px;">Hedge Offer</h2>
				<p style="margin-bottom: 15px;">Choose hedge position<br>Select a market to hedge your exposure.</p>

				<!-- Offer block -->
				<div style="font-family: Arial, sans-serif; color: #ffffff; background-color: #1a2a50; padding: 20px; border-radius: 12px; max-width: 600px; margin: auto;">
					<div class="table-wrapper" style="overflow-x:auto; margin-top: 10px;">
						<table style="width: 100%; border-collapse: collapse; background-color: #243b70; border-radius: 8px; overflow: hidden;">
							<thead>
								<tr style="background-color: #1f2e5a;">
									<th style="padding: 10px; text-align: left;">Market</th>
									<th style="padding: 10px; text-align: left;">% Hedge</th>
									<th style="padding: 10px; text-align: left;">Liquidity</th>
									<th style="padding: 10px; text-align: left;">Select</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="padding: 10px;">SOL up / down</td>
									<td style="padding: 10px;">10%</td>
									<td style="padding: 10px;">$50K</td>
									<td style="padding: 10px;"><input type="radio" name="hedge-select"></td>
								</tr>
								<tr>
									<td style="padding: 10px;">BTC up / down</td>
									<td style="padding: 10px;">15%</td>
									<td style="padding: 10px;">$120K</td>
									<td style="padding: 10px;"><input type="radio" name="hedge-select"></td>
								</tr>
							</tbody>
						</table>
					</div>

					<div style="margin-top: 20px; background-color: #243b70; padding: 10px 15px; border-radius: 8px;">
						<p style="margin-bottom: 8px; font-weight: bold;">Payment options:</p>
						<label style="display: block; margin-bottom: 5px;">
							<input type="radio" name="payment-option" checked>
							Pay with portfolio funds
						</label>
						<label style="display: block;">
							<input type="radio" name="payment-option">
							Pay additionally
						</label>
					</div>
				</div>

				<button id="hedgeNowBtn" class="btn btn-gradient btn-round" style="margin-top: 20px;">Hedge now</button>
			</div>
		</div>

		<!-- Confirmation Popup -->
		<div id="popup-hedge-confirmation-overlay" class="popup-overlay">
			<div id="popup-hedge-confirmation" class="popup" style="max-width: 500px; text-align:center;">
				<img src="images/solana-sol-logo.png" alt="Solana" style="width:70px; margin-bottom:15px;">
				<h2 style="margin-bottom: 10px;">Confirm transaction in your wallet</h2>
				<p style="font-style: italic; margin-bottom: 20px;">
					Please check your wallet to approve this transaction.
				</p>
			</div>
		</div>

		<!-- Result Popup -->
		<div id="popup-hedge-result-overlay" class="popup-overlay">
			<div id="popup-hedge-result" class="popup" style="max-width: 500px; text-align:center;">
				<img src="images/+.png" alt="Success" style="width:70px; margin-bottom:15px;">
				<h2 style="margin-bottom: 10px;">Hedge completed successfully!</h2>
				<p style="margin-bottom: 20px;">Manage it via Dashboard.</p>
				<button class="btn btn-gradient btn-round" style="margin-bottom:10px;" onclick="document.querySelectorAll('.popup-overlay').forEach(o => o.style.display='none')">
					Go to Dashboard
				</button>
				<button class="btn btn-round" style="background-color:#1a2a50; border:1px solid #9ac31c; color:#9ac31c;">
					Share on Twitter
				</button>
			</div>
		</div>
		<audio id="popup-sound" src="effects/fanfare.mp3" preload="auto"></audio>

		<!-- <div id="popup-hedge-error-overlay" class="popup-overlay" style="display:none;">
		<div id="popup-hedge-error" class="popup" style="max-width: 500px; text-align:center;">
			<img src="images/-.png" alt="Error" style="width:70px; margin-bottom:15px;">
			<h2 style="margin-bottom: 10px; color:#ec6320;">Hedge failed!</h2>
			<p style="margin-bottom: 20px;">Please try again later.</p>
			<button class="btn btn-gradient btn-round" style="margin-bottom:10px;"
			onclick="document.querySelectorAll('.popup-overlay').forEach(o => o.style.display='none')">
			Go to Dashboard
			</button>
		</div>
		</div>
		<audio id="popup-error-sound" src="effects/disappointment.mp3" preload="auto"></audio> -->

		<!-- JS Logic -->
		<script>
			const sound = document.getElementById('popup-sound');
			
			document.addEventListener('DOMContentLoaded', () => {
				let hedgeTimeout = null;
				let isProcessing = false;
				const connectBtn = document.getElementById('connectWalletBtn');
				
				function openPopup(id) {
					document.querySelectorAll('.popup-overlay').forEach(o => o.style.display = 'none');
					const el = document.getElementById(id);
					if (el) el.style.display = 'flex';
					
					if (id === 'popup-hedge-result-overlay') {
						sound.play().catch(() => {});
					}
				}
				
				function closePopup(id) {
					const el = document.getElementById(id);
					if (el) el.style.display = 'none';
				}
				
				connectBtn.addEventListener('click', () => { // натискання кнопки Connect → показати попап з вибором гаманця
				openPopup('popup-wallet-overlay');
				});
				
				// --- Phantom ---
				document.getElementById('wallet-phantom').addEventListener('click', async () => {
					closePopup('popup-wallet-overlay');
					openPopup('popup-hedge-confirmation-overlay');
					try {
						if (!window.solana || !window.solana.isPhantom) {
							alert('Install Phantom Wallet');
							closePopup('popup-hedge-confirmation-overlay');
							return;
						}
						const resp = await window.solana.connect();
						console.log('Phantom connected:', resp.publicKey.toString());
						connectBtn.textContent = 'Phantom: ' + resp.publicKey.toString().slice(0,4) + '...' + resp.publicKey.toString().slice(-4);
						closePopup('popup-hedge-confirmation-overlay');
						} catch (err) {
							console.error(err);
							closePopup('popup-hedge-confirmation-overlay');
						}
						});
						
						// --- Backpack ---
						document.getElementById('wallet-backpack').addEventListener('click', async () => {
							closePopup('popup-wallet-overlay');
							openPopup('popup-hedge-confirmation-overlay');
							try {
								if (!window.ethereum) {
									alert('Install Backpack or MetaMask');
									closePopup('popup-hedge-confirmation-overlay');
									return;
								}
								const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
								console.log('Backpack connected:', accounts[0]);
								connectBtn.textContent = 'Backpack: ' + accounts[0].slice(0,4) + '...' + accounts[0].slice(-4);
								closePopup('popup-hedge-confirmation-overlay');
								} catch (err) {
									console.error(err);
									closePopup('popup-hedge-confirmation-overlay');
								}
								});
								
								// Add new hedge — Loading → Offer
								const addBtn = document.getElementById('addHedgeBtn');
								if (addBtn) {
									addBtn.addEventListener('click', e => {
										e.preventDefault();
										if (isProcessing) return;
										isProcessing = true;
										document.querySelectorAll('.popup-overlay').forEach(o => o.style.display = 'none');
										openPopup('popup-overlay');
										hedgeTimeout = setTimeout(() => {
											closePopup('popup-overlay');
											openPopup('popup-hedge-offer-overlay');
											isProcessing = false;
											}, 2000);
											});
										}
										
										// Hedge now → Confirmation → Result
										const hedgeNowBtn = document.getElementById('hedgeNowBtn');
										if (hedgeNowBtn) {
											hedgeNowBtn.addEventListener('click', e => {
												e.preventDefault();
												closePopup('popup-hedge-offer-overlay');
												openPopup('popup-hedge-confirmation-overlay');
												setTimeout(() => {
													closePopup('popup-hedge-confirmation-overlay');
													openPopup('popup-hedge-result-overlay');
													}, 2000);
													});
												}
												
												// Go to Dashboard
												const goDashboardBtn = document.querySelector('#popup-hedge-result-overlay .btn-gradient');
												if (goDashboardBtn) {
													goDashboardBtn.addEventListener('click', () => {
														closePopup('popup-hedge-result-overlay');
														});
													}
													
													document.querySelectorAll('.popup-overlay').forEach(overlay => {
														overlay.addEventListener('click', e => {
															if (e.target === overlay) overlay.style.display = 'none';
															});
															});
															});
		</script>

		<!-- JS Background music -->
		<script>
			const audio = new Audio('effects/cryptonight.mp3');
			audio.loop = true;
			audio.volume = 0.15;
			function startAudio() {
				audio.play();
				document.body.removeEventListener('click', startAudio);
				document.body.removeEventListener('touchstart', startAudio);
			}
			document.body.addEventListener('click', startAudio);
			document.body.addEventListener('touchstart', startAudio);
		</script>

		<!-- JS Logic Schedule -->
		<script>
			const currencies = {
				SOL: "solana",
				USDC: "usd-coin",
				MET: "meteora"
				};
				
				const pointsPerDay = 4; // чверті дня
				const forecastDays = 3; // прогноз на m днів
				const trainDays = 7;    // навчання на останніх n днів
				
				async function loadData(coinId) {
					const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${trainDays}`);
					const data = await res.json();
					return data.prices.map(p => ({ time: new Date(p[0]), price: p[1] }));
				}
				
				function localRegression(prices, windowSize, predictCount) {
					const result = [...prices.map(p => p.price)];
					for (let i = 0; i < predictCount; i++) {
						const start = Math.max(result.length - windowSize, 0);
						const ys = result.slice(start);
						const xs = Array.from({ length: ys.length }, (_, j) => j);
						const n = xs.length;
						const sumX = xs.reduce((a, b) => a + b, 0);
						const sumY = ys.reduce((a, b) => a + b, 0);
						const sumXY = xs.reduce((a, b, j) => a + b * ys[j], 0);
						const sumX2 = xs.reduce((a, b) => a + b * b, 0);
						const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
						const intercept = (sumY - slope * sumX) / n;
						result.push(slope * ys.length + intercept);
					}
					return result.slice(prices.length); // тільки прогнозні точки
				}
				
				async function buildChart(selectedCurrency) {
					const prices = await loadData(currencies[selectedCurrency]);
					const windowSize = 6;
					const predictPoints = forecastDays * pointsPerDay;
					const msStep = 6 * 60 * 60 * 1000;
					
					// Forecast
					const predicted = localRegression(prices, windowSize, predictPoints);
					const forecastData = Array(prices.length-1).fill(null);
					forecastData.push(prices[prices.length-1].price);
					forecastData.push(...predicted);
					
					// EMA
					const emaPeriod = 5;
					const alpha = 2/(emaPeriod+1);
					const emaValues = [];
					for(let i=0;i<prices.length;i++){
						if(i===0) emaValues.push(prices[i].price);
						else emaValues.push(alpha*prices[i].price + (1-alpha)*emaValues[i-1]);
					}
					let lastEMA = emaValues[emaValues.length-1];
					for(let i=0;i<predicted.length;i++){
						lastEMA = alpha*predicted[i] + (1-alpha)*lastEMA;
						emaValues.push(lastEMA);
					}
					
					const labels = prices.map(p=>p.time.toLocaleString('en-GB',{hour12:false,hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'}))
					.concat(predicted.map((_,i)=>new Date(prices[prices.length-1].time.getTime()+(i+1)*msStep)
					.toLocaleString('en-GB',{hour12:false,hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'})));
					
					// Buy/Sell/Break-even
					const buyPrice = prices[0].price;
					const sellPrice = prices[prices.length-1].price;
					const breakEven = buyPrice / 1.2;
					
					const backgroundPlugin = {
						id:'background_zones',
						beforeDraw:(chart)=>{
							const ctx=chart.ctx;
							const yScale=chart.scales.y;
							const area=chart.chartArea;
							const yBuy=yScale.getPixelForValue(buyPrice);
							const ySell=yScale.getPixelForValue(sellPrice);
							const yBreak=yScale.getPixelForValue(breakEven);
							ctx.save();
							ctx.fillStyle='rgba(16,185,129,0.12)'; ctx.fillRect(area.left,yBuy,area.right-area.left,area.bottom-yBuy);
							ctx.fillStyle='rgba(239,68,68,0.12)'; ctx.fillRect(area.left,area.top,area.right-area.left,ySell-area.top);
							ctx.fillStyle='rgba(250,204,21,0.15)'; ctx.fillRect(area.left,Math.min(yBuy,yBreak),area.right-area.left,Math.abs(yBreak-yBuy));
							ctx.restore();
						}
						};
						
						const ctx = document.getElementById('cryptoChart').getContext('2d');
						if(window.chart) window.chart.destroy();
						window.chart = new Chart(ctx,{
							type:'line',
							data:{
								labels,
								datasets:[
								{ label: selectedCurrency + ' Price', data: prices.map(p=>p.price), borderColor:'#38bdf8', backgroundColor:'rgba(56,189,248,0.25)', tension:0.3, pointRadius:0 },
								{ label:'Forecast', data:forecastData, borderColor:'#a78bfa', borderDash:[6,4], borderWidth:2, tension:0.4, pointRadius:2, pointBackgroundColor:'#a78bfa', hidden:!document.getElementById('toggleForecast').checked },
								{ label:'EMA', data:emaValues, borderColor:'#f472b6', borderWidth:2, pointRadius:0, tension:0.4, hidden:!document.getElementById('toggleEMA').checked },
								{ label:'Buy Price', data:prices.concat(predicted).map(()=>buyPrice), borderColor:'#10b981', borderDash:[5,5], borderWidth:1, pointRadius:0 },
								{ label:'Sell Price', data:prices.concat(predicted).map(()=>sellPrice), borderColor:'#ef4444', borderDash:[5,5], borderWidth:1, pointRadius:0 },
								{ label:'Break-even', data:prices.concat(predicted).map(()=>breakEven), borderColor:'#facc15', borderDash:[5,5], borderWidth:1, pointRadius:0 }
								]
								},
								options:{
									responsive:true,
									plugins:{ legend:{ labels:{ color:'#e2e8f0' } }, title:{ display:true, text:selectedCurrency + ' — Forecast', color:'#e2e8f0', font:{ size:16 } } },
									scales:{ x:{ ticks:{ color:'#94a3b8' } }, y:{ ticks:{ color:'#94a3b8' } } }
									},
									plugins:[backgroundPlugin]
									});
								}
								
								// --- Event listeners ---
								document.getElementById('toggleForecast').addEventListener('change', e=>{
									if(window.chart) window.chart.data.datasets[1].hidden = !e.target.checked;
									if(window.chart) window.chart.update();
									});
									document.getElementById('toggleEMA').addEventListener('change', e=>{
										if(window.chart) window.chart.data.datasets[2].hidden = !e.target.checked;
										if(window.chart) window.chart.update();
										});
										document.querySelectorAll('input[name="currency"]').forEach(radio=>{
											radio.addEventListener('change', e=>{
												buildChart(e.target.value);
												});
												});
												
												// Initial load
												buildChart('SOL');
		</script>
	</body>
</html>
